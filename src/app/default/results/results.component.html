<mat-card>
  <mat-card-content>
    <div fxLayout="row wrap">
      <div fxFlex.gt-sm="100" fxFlex.gt-xs="100" fxFlex="100" fxLayoutAlign="center center">
        <mat-card-title>Retrieving Results</mat-card-title>
      </div>
    </div>

    <hr />

    <div fxLayout="row wrap">
      <div fxFlex.gt-sm="30" fxFlex.gt-xs="30" fxFlex="100" fxLayoutAlign="center start" style="padding: 5px">
        <form class="m-t-20" [formGroup]="myForm" (ngSubmit)="onSubmit()">
          <mat-form-field class="example-full-width">
            <mat-select placeholder="Organisation.." formControlName="organisation">
              <mat-option *ngFor="let option of organisations" [value]="option.occupation">{{ option.occupation }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field class="example-full-width">
            <input matInput [matDatepicker]="picker" formControlName="startdate" placeholder="Start Date" readonly="true" />
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker type="datetime" touchUi clockStep="5" #picker></mat-datepicker>
          </mat-form-field>

          <mat-form-field class="example-full-width">
            <input matInput [matDatepicker]="picker2" formControlName="enddate" placeholder="End Date" readonly="true" />
            <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
            <mat-datepicker type="datetime" touchUi clockStep="5" #picker2></mat-datepicker>
          </mat-form-field>

          <mat-card-actions fxLayout="column" fxLayoutAlign="space-around center">
            <button mat-raised-button color="primary" type="submit" style="width: 100%; margin-bottom: 5px" [disabled]="!myForm.valid">Submit</button>
            <button mat-raised-button color="accent" type="button" style="width: 100%" [disabled]="!csv" (click)="download()">Download</button>
          </mat-card-actions>
        </form>
      </div>
      <div fxFlex.gt-sm="70" fxFlex.gt-xs="70" fxFlex="100" style="padding: 5px">
        <mat-card-title>
          <mat-spinner [diameter]="30" *ngIf="!dataFetched"></mat-spinner>
        </mat-card-title>
        <div class="bg-light p-10 p-r-20 p-l-20">
          <mat-form-field>
            <input matInput (keyup)="applyFilter($event.target.value)" placeholder="Filter" />
          </mat-form-field>
        </div>
        <div class="responsive-table" [hidden]="dataFetched">
          <mat-table #Table [dataSource]="dataSource" matSort>
            <ng-container matColumnDef="pathwayname">
              <mat-header-cell *matHeaderCellDef mat-sort-header> Pathway Name </mat-header-cell>
              <mat-cell *matCellDef="let task"> {{ task.pathwayname }} </mat-cell>
            </ng-container>

            <ng-container matColumnDef="result">
              <mat-header-cell *matHeaderCellDef mat-sort-header> Result </mat-header-cell>
              <mat-cell *matCellDef="let task"> {{ task.result }} </mat-cell>
            </ng-container>

            <ng-container matColumnDef="barcode_value">
              <mat-header-cell *matHeaderCellDef mat-sort-header> Barcode </mat-header-cell>
              <mat-cell *matCellDef="let task"> {{ task.barcode_value }} </mat-cell>
            </ng-container>

            <ng-container matColumnDef="requestedDT">
              <mat-header-cell *matHeaderCellDef mat-sort-header> Submitted Time </mat-header-cell>
              <mat-cell *matCellDef="let task"> {{ task.requestedDT }} </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
          </mat-table>
          <mat-paginator #paginator [pageSize]="10" [pageSizeOptions]="[10, 25, 50, 100]"> </mat-paginator>
        </div>
      </div>
    </div>
  </mat-card-content>
</mat-card>

<mat-card>
  <mat-card-content>
    <div fxLayout="row wrap">
      <div fxFlex.gt-sm="100" fxFlex.gt-xs="100" fxFlex="100" fxLayoutAlign="center center">
        <mat-card-title>Database Structure</mat-card-title>
      </div>
    </div>

    <hr />

    <div fxLayout="row wrap">
      <div fxFlex.gt-sm="50" fxFlex.gt-xs="50" fxFlex="100" fxLayoutAlign="center center">
        <img src="../../../assets/images/database-diagram.png" style="min-height: 800px; height: 60vh" />
      </div>
      <div fxFlex.gt-sm="50" fxFlex.gt-xs="50" fxFlex="100" flexDirection="column">
        <h5>Database Notes</h5>
        <ul>
          <li><strong>lamp90_results</strong> - Table that stores results as received from Lab, linked on barcode_value to pathway_data_collected</li>

          <li><strong>pathway_data_collected</strong> - Table that stores Tests requested, initially populated by mobile app submission of a test & barcode. Each row is updated throughout process of test from test taken to resulting and notification being sent to test subject of result. The occupation field here is used to inform decision on which Organisation can view result (e.g. occupation = "BTH Staff Member" would be shown to Blackpool Teaching Hospital team)</li>

          <li><strong>registeredstaff</strong> - Populated as staff complete initial sign up form in order to grant access to the Mobile App</li>

          <li><strong>healthinfo_codes</strong> - Populated by staff completing the section of the onboarding site that allows them to pre-populate the test questions in the Mobile App. Used to save time for staff who repeat testing by linking their NHS Number to their Active Directory account.</li>

          <li><strong>staffconsent</strong> - NO LONGER USED</li>

          <li><strong>pathway_reminders_log</strong> - Log of when follow up reminders messages are sent to staff. Automated to go out 7 days after a previous negative test or 90 days after a previous positive test (if the person hasn't taken a subsequent test already)</li>

          <li><strong>pathways</strong> - Lookup of the different Pathway types (e.g. "LAMP - Self Test", "LAMP - Test Others")</li>

          <li><strong>lamp90_lab_receipts</strong> - Record of Lab scanning in barcode of test vial on receipt into the laboratory.</li>

          <li><strong>rejection_reasons</strong> - List of valid rejection reasons</li>

          <li><strong>lamp90_lab_receipts_audit</strong> - audit table for actions taken on lab receiption machines</li>

          <li><strong>pathway_data_failures</strong> - log of any failures in automated pipeline of messages across the system</li>

          <li><strong>trainingresources, occupations, occupation_census, ethnicity, pathlabs, testcentres</strong> - tables to populate dropdowns in applications</li>

          <li><strong>orgstructures</strong> - department/division structure for each organisation, to allow staff to select their own area(s), in order to allow Occupation Health teams to filter by area</li>

          <li><strong>staffarea</strong> - recording of which NHS Number is assigned to which area</li>

          <li><strong>orgacknowledgements</strong> - record of when Organisation staff have acknowledged a member of staff's positive result on the Workforce Dashboard</li>
        </ul>
      </div>
    </div>
  </mat-card-content>
</mat-card>
